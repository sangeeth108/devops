pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials') // DockerHub credentials
        SERVER_CREDENTIALS = credentials('server-credentials') // Remote server credentials
        BACKEND_IMAGE = "sangeeth108/express-backend"
        FRONTEND_IMAGE = "sangeeth108/nextjs-frontend"
        REMOTE_HOST = "143.244.136.237"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Docker Login') {
            steps {
                script {
                    // Log in to DockerHub
                    sh """
                        echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
                    """
                }
            }
        }

        stage('Pull Backend Image') {
            steps {
                script {
                    // Pull the backend image from DockerHub
                    sh """
                        docker pull ${BACKEND_IMAGE}
                    """
                }
            }
        }

        stage('Pull Frontend Image') {
            steps {
                script {
                    // Pull the frontend image from DockerHub
                    sh """
                        docker pull ${FRONTEND_IMAGE}
                    """
                }
            }
        }

        stage('Stop and Remove Existing Backend Container') {
            steps {
                script {
                    // Stop and remove the existing backend container (if running)
                    sh """
                        docker stop backend || true && docker rm backend || true
                    """
                }
            }
        }

        stage('Stop and Remove Existing Frontend Container') {
            steps {
                script {
                    // Stop and remove the existing frontend container (if running)
                    sh """
                        docker stop frontend || true && docker rm frontend || true
                    """
                }
            }
        }

        stage('Deploy Backend Container') {
            steps {
                script {
                    // Run the backend container on the remote server
                    sh """
                        docker run -d -p 5000:5000 --name backend ${BACKEND_IMAGE}
                    """
                }
            }
        }

        stage('Deploy Frontend Container') {
            steps {
                script {
                    // Run the frontend container on the remote server
                    sh """
                        docker run -d -p 3000:3000 --name frontend ${FRONTEND_IMAGE}
                    """
                }
            }
        }

        stage('Final Cleanup') {
            steps {
                script {
                    // Final cleanup if needed
                    echo "Deployment complete."
                }
            }
        }
    }
}
